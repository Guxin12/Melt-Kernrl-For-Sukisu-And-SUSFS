name: Kernel Builder

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "é€‰æ‹©æž„å»ºç±»åž‹"
        required: true
        default: "image"
        type: choice
        options:
          - image
          - ak3

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: Guxin12/android_kernel_xiaomi_marble
          ref: melt-rebase
          fetch-depth: 1
          lfs: false

      - name: Install build essentials
        run: |
          sudo apt-get update
          sudo apt-get install -y make flex bison libssl-dev libelf-dev bc build-essential ccache lld zip
          
          # è®¾ç½®ccache
          sudo mkdir /ccache
          sudo chmod 777 /ccache
          echo "CCACHE_DIR=/ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          
          echo "REPO_ROOT=$(pwd)" >> $GITHUB_ENV
          echo "SYS_PATH=/usr/bin" >> $GITHUB_ENV
          
          # éªŒè¯å·¥å…·å®‰è£…
          echo "=== å·¥å…·ç‰ˆæœ¬ ==="
          make --version | head -1
          gcc --version | head -1
          flex --version
          bison --version
          ccache --version
          ld.lld --version || echo "ld.lld available"
          echo "================"

      - name: Download Clang
        run: |
          mkdir clang
          echo "ä¸‹è½½ Clang ç¼–è¯‘å™¨..."
          wget -q --show-progress --progress=bar:force -O clang.tar.gz \
            "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/428d18d9732aa7ebfcaed87a582d86155db878d4/clang-r416183b.tar.gz"
          
          # éªŒè¯ä¸‹è½½å®Œæ•´æ€§
          if [ $(stat -c%s clang.tar.gz) -lt 100000000 ]; then
            echo "âŒ é”™è¯¯ï¼šä¸‹è½½æ–‡ä»¶ä¸å®Œæ•´"
            exit 1
          fi
          
          echo "è§£åŽ‹ Clang..."
          tar -zxf clang.tar.gz -C clang
          
          # ç¡®ä¿ld.lldå­˜åœ¨
          [ ! -f "clang/bin/ld.lld" ] && ln -s $(which ld.lld) clang/bin/ld.lld
          
          echo "CLANG_PATH=$(pwd)/clang/bin" >> $GITHUB_ENV
          echo "=== Clang ç‰ˆæœ¬ ==="
          clang/bin/clang --version | head -1
          clang/bin/ld.lld --version | head -1
          echo "=================="

      - name: Build kernel (without LTO)
        run: |
          # è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒ
          export PATH="${{ env.CLANG_PATH }}:/usr/lib/ccache:${{ env.SYS_PATH }}:$PATH"
          export CC="ccache clang"
          export CXX="ccache clang++"
          
          # æ¸…ç†å¹¶é…ç½®
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 O=out mrproper
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 O=out marble_defconfig
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 O=out -j$(nproc --all)
          
          # æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
          ccache -s

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          cp out/arch/arm64/boot/Image artifacts/kernel.img
          
          # èŽ·å–å†…æ ¸ç‰ˆæœ¬
          grep -a "Linux version" out/vmlinux | awk '{print $3}' | head -1 > artifacts/kernel_version.txt
          
          echo "BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M')" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$(cat artifacts/kernel_version.txt)" >> $GITHUB_ENV
          
          echo "=== æž„å»ºä¿¡æ¯ ==="
          echo "ç‰ˆæœ¬: $(cat artifacts/kernel_version.txt)"
          echo "æ—¥æœŸ: ${{ env.BUILD_DATE }}"
          echo "================"

      - name: Upload kernel image
        if: ${{ inputs.build_type == 'image' }}
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: artifacts/kernel.img

      - name: Package AK3
        if: ${{ inputs.build_type == 'ak3' }}
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          cp artifacts/kernel.img ak3/Image
          
          # æ›´æ–°anykernel.shé…ç½®
          sed -i \
            -e "s|kernel\.string=.*|kernel.string=Marble-Kernel-${{ env.KERNEL_VERSION }}|" \
            -e "s|device\.name1=.*|device.name1=marble|" \
            -e "s|device\.name2=.*|device.name2=marblein|" \
            ak3/anykernel.sh
          
          # æ‰“åŒ…ZIP
          cd ak3
          zip -r9 "../artifacts/marble_melt_${{ env.KERNEL_VERSION }}.zip" *
          
          echo "AK3_PATH=artifacts/marble_melt_${{ env.KERNEL_VERSION }}.zip" >> $GITHUB_ENV

      - name: Upload AK3 package
        if: ${{ inputs.build_type == 'ak3' }}
        uses: actions/upload-artifact@v4
        with:
          name: kernel-ak3
          path: ${{ env.AK3_PATH }}

      - name: Create build summary
        run: |
          echo "### ðŸš€ å†…æ ¸æž„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "#### æºç ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- ä»“åº“: [Guxin12/android_kernel_xiaomi_marble](https://github.com/Guxin12/android_kernel_xiaomi_marble)" >> $GITHUB_STEP_SUMMARY
          echo "- åˆ†æ”¯: \`melt-rebase\`" >> $GITHUB_STEP_SUMMARY
          echo "#### æž„å»ºå‚æ•°" >> $GITHUB_STEP_SUMMARY
          echo "- ç±»åž‹: \`${{ inputs.build_type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- é…ç½®: \`marble_defconfig\`" >> $GITHUB_STEP_SUMMARY
          echo "- ä¼˜åŒ–: \`O3 (æ— LTO)\`" >> $GITHUB_STEP_SUMMARY
          echo "#### ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- å†…æ ¸ç‰ˆæœ¬: \`${{ env.KERNEL_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- æž„å»ºæ—¶é—´: \`${{ env.BUILD_DATE }} UTC\`" >> $GITHUB_STEP_SUMMARY
          echo "#### è¾“å‡ºæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.build_type }}" = "image" ]; then
            echo "- Kernel Image: \`kernel.img\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- AK3 Package: \`$(basename ${{ env.AK3_PATH }})\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "> æž„å»ºID: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"