name: Kernel Builder

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "é€‰æ‹©æ„å»ºç±»å‹"
        required: true
        default: "image"
        type: choice
        options:
          - image
          - ak3
      kernelsu_variant:
        description: "é€‰æ‹©KernelSUå˜ä½“"
        required: true
        default: "Official"
        type: choice
        options:
          - "Official"
          - "Next"
          - "MKSU"
          - "SukiSU"
      kernelsu_branch:
        description: "é€‰æ‹©KernelSUåˆ†æ”¯"
        required: true
        default: "Dev(å¼€å‘)"
        type: choice
        options:
          - "Stable(æ ‡å‡†)"
          - "Dev(å¼€å‘)"
      use_kpm:
        description: "å¯ç”¨KPMæ”¯æŒ(SukiSUä¸“ç”¨)"
        required: true
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: Guxin12/android_kernel_xiaomi_marble
          ref: melt-rebase
          path: melt
          fetch-depth: 1
          lfs: false

      - name: Clone SUSFS and SukiSU patches
        run: |
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android12-5.10
          git clone https://github.com/ShirkNeko/SukiSU_patch.git

      - name: Install build essentials    
        run: |    
          sudo apt-get update    
          sudo apt-get install -y make flex bison libssl-dev libelf-dev bc build-essential ccache lld zip patch wget
          
          # è®¾ç½®ccache    
          sudo mkdir /ccache    
          sudo chmod 777 /ccache    
          echo "CCACHE_DIR=/ccache" >> $GITHUB_ENV    
          echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV    
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV    
              
          echo "REPO_ROOT=$(pwd)" >> $GITHUB_ENV    
          echo "SYS_PATH=/usr/bin" >> $GITHUB_ENV    
              
          # éªŒè¯å·¥å…·å®‰è£…    
          echo "=== å·¥å…·ç‰ˆæœ¬ ==="    
          make --version | head -1    
          gcc --version | head -1    
          flex --version    
          bison --version    
          ccache --version    
          ld.lld --version || echo "ld.lld available"    
          echo "================"    

      - name: Download Clang    
        run: |    
          mkdir -p clang    
          echo "ä¸‹è½½ Clang ç¼–è¯‘å™¨..."    
          
          # ä½¿ç”¨å¯é çš„é•œåƒï¿½ï¿½
          CLANG_URL="https://mirror.ghproxy.com/https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/428d18d9732aa7ebfcaed87a582d86155db878d4/clang-r416183b.tar.gz"
          
          # ä½¿ç”¨é‡è¯•æœºåˆ¶ä¸‹è½½
          for i in {1..3}; do
            echo "å°è¯•ä¸‹è½½ Clang (ç¬¬ $i æ¬¡)..."
            if wget --tries=3 --waitretry=5 --progress=bar:force -O clang.tar.gz "$CLANG_URL"; then
              # éªŒè¯ä¸‹è½½å®Œæ•´æ€§
              if [ $(stat -c%s clang.tar.gz) -gt 100000000 ]; then
                echo "ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å¤§å°: $(stat -c%s clang.tar.gz) å­—èŠ‚"
                break
              else
                echo "ä¸‹è½½æ–‡ä»¶å¤ªå°($(stat -c%s clang.tar.gz)å­—èŠ‚)ï¼Œå¯èƒ½ä¸å®Œæ•´"
                if [ $i -lt 3 ]; then
                  echo "ç­‰å¾… 5 ç§’åé‡è¯•..."
                  sleep 5
                fi
                rm -f clang.tar.gz
              fi
            else
              echo "ä¸‹è½½å¤±è´¥"
              if [ $i -lt 3 ]; then
                echo "ç­‰å¾… 5 ç§’åé‡è¯•..."
                sleep 5
              fi
              rm -f clang.tar.gz
            fi
          done
          
          # æ£€æŸ¥æ˜¯å¦ä¸‹è½½æˆåŠŸ
          if [ ! -f "clang.tar.gz" ]; then
            echo "âŒ é”™è¯¯ï¼šClang ä¸‹è½½å¤±è´¥"
            exit 1
          fi
              
          echo "è§£å‹ Clang..."    
          tar -zxf clang.tar.gz -C clang    
              
          # ç¡®ä¿ld.lldå­˜åœ¨    
          if [ ! -f "clang/bin/ld.lld" ]; then
            echo "åˆ›å»º ld.lld é“¾æ¥"
            ln -s $(which ld.lld) clang/bin/ld.lld || true
          fi
              
          echo "CLANG_PATH=$(pwd)/clang/bin" >> $GITHUB_ENV    
          echo "=== Clang ç‰ˆæœ¬ ==="    
          clang/bin/clang --version | head -1 || echo "æ— æ³•è·å–Clangç‰ˆæœ¬"    
          clang/bin/ld.lld --version | head -1 || echo "æ— æ³•è·å–ld.lldç‰ˆæœ¬"    
          echo "=================="    
          # æ¸…ç†ä¸‹è½½æ–‡ä»¶
          rm -f clang.tar.gz

      - name: ç¡®å®š KernelSU çš„åˆ†æ”¯
        run: |
          branch_input="${{ inputs.kernelsu_branch }}"
          variant_input="${{ inputs.kernelsu_variant }}"
          
          case "$branch_input" in
            "Stable(æ ‡å‡†)")
              echo "BRANCH=-" >> $GITHUB_ENV
              ;;
            "Dev(å¼€å‘)")
              case "$variant_input" in
                "Official" | "MKSU") echo "BRANCH=-s main" >> $GITHUB_ENV ;;
                "Next")              echo "BRANCH=-s next-susfs-dev" >> $GITHUB_ENV ;;
                "SukiSU")           echo "BRANCH=-s susfs-main" >> $GITHUB_ENV ;;
                *) 
                  echo "é”™è¯¯ï¼šæœªå®šä¹‰å¼€å‘åˆ†æ”¯çš„å˜ä½“ '$variant_input'" >&2
                  exit 1
                  ;;
              esac
              ;;
            *)
              echo "é”™è¯¯ï¼šéœ€è¦è‡ªå®šä¹‰åˆ†æ”¯æ—¶æœªæä¾›å‚æ•°" >&2
              exit 1
              ;;
          esac

      - name: æ·»åŠ  KernelSU
        run: |
          # æ£€æŸ¥æ˜¯å¦åœ¨meltç›®å½•
          if [ ! -d "melt" ]; then
            echo "é”™è¯¯ï¼šmeltç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          # å¦‚æœä¸åœ¨meltç›®å½•ï¼Œåˆ™è¿›å…¥
          if [ "$(basename $(pwd))" != "melt" ]; then
            cd melt
          fi
          
          if [ "${{ inputs.kernelsu_variant }}" == "Official" ]; then
            echo "Adding KernelSU Official..."
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash $BRANCH
          elif [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            echo "Adding KernelSU Next..."
            curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next-susfs/kernel/setup.sh" | bash $BRANCH
          elif [ "${{ inputs.kernelsu_variant }}" == "MKSU" ]; then
            echo "Adding KernelSU MKSU..."
            curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh" | bash $BRANCH
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "Adding KernelSU SukiSU..."
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash $BRANCH
          fi
          
          # è¿”å›å·¥ä½œç›®å½•
          if [ "$(basename $(pwd))" == "melt" ]; then
            cd ..
          fi

      - name: ä¸º KernelSU å˜ä½“å®‰è£… SUSFS è¡¥ä¸
        run: |
          # æ£€æŸ¥æ˜¯å¦åœ¨meltç›®å½•
          if [ ! -d "melt" ]; then
            echo "é”™è¯¯ï¼šmeltç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          # å¦‚æœä¸åœ¨meltç›®å½•ï¼Œåˆ™è¿›å…¥
          if [ "$(basename $(pwd))" != "melt" ]; then
            cd melt
          fi
          
          echo "Applying SUSFS patches..."
          
          # å¤åˆ¶é€šç”¨SUSFSè¡¥ä¸
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch ./
          cp -r ../susfs4ksu/kernel_patches/fs/* ./fs/
          cp -r ../susfs4ksu/kernel_patches/include/linux/* ./include/linux/

          # åº”ç”¨å˜ä½“ç‰¹å®šè¡¥ä¸
          if [ "${{ inputs.kernelsu_variant }}" == "Official" ]; then
            echo "Applying SUSFS patches for Official KernelSU..."
            cd ./KernelSU
            cp ../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
            patch -p1 --forward --fuzz=3 < 10_enable_susfs_for_ksu.patch
            cd ..
          elif [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            echo "Applying SUSFS patches for KernelSU-Next..."
            cd ./KernelSU-Next
            curl -LSs "https://raw.githubusercontent.com/zzh20188/GKI_KernelSU_SUSFS/dev/0001-kernel-patch-susfs-v1.5.7-to-KernelSU-Next-v1.0.7.patch" -o susfs.patch
            patch -p1 --forward < susfs.patch || true
            cd ..
          elif [ "${{ inputs.kernelsu_variant }}" == "MKSU" ]; then
            echo "Applying SUSFS patches for MKSU..."
            cd ./KernelSU
            cp ../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
            patch -p1 --forward --fuzz=3 < 10_enable_susfs_for_ksu.patch || true
            cd ..
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "Applying SUSFS patches for SukiSU..."
            # SukiSUä¸éœ€è¦é¢å¤–è¡¥ä¸
          fi

          # åº”ç”¨ä¸»SUSFSè¡¥ä¸
          patch -p1 --fuzz=3 < 50_add_susfs_in_gki-android12-5.10.patch || true
          
          # è¿”å›å·¥ä½œç›®å½•
          if [ "$(basename $(pwd))" == "melt" ]; then
            cd ..
          fi
  
      - name: åº”ç”¨æ–°çš„HOOKSè¡¥ä¸
        run: |
          # æ£€æŸ¥æ˜¯å¦åœ¨meltç›®å½•
          if [ ! -d "melt" ]; then
            echo "é”™è¯¯ï¼šmeltç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          # å¦‚æœä¸åœ¨meltç›®å½•ï¼Œåˆ™è¿›å…¥
          if [ "$(basename $(pwd))" != "melt" ]; then
            cd melt
          fi
          
          if [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            echo "Applying hooks for KernelSU-Next..."
            # æ³¨æ„ï¼šè·¯å¾„å·²ä¿®æ­£ä¸ºä»æ ¹ç›®å½•å¼€å§‹
            cp ../susfs4ksu/kernel_patches/next/scope_min_manual_hooks_v1.4.patch ./
            patch -p1 -F 3 < scope_min_manual_hooks_v1.4.patch
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "Applying hooks for SukiSU..."
            # æ³¨æ„ï¼šè·¯å¾„å·²ä¿®æ­£ä¸ºä»æ ¹ç›®å½•å¼€å§‹
            cp ../SukiSU_patch/hooks/syscall_hooks.patch ./
            patch -p1 -F 3 < syscall_hooks.patch
          fi
          
          # è¿”å›å·¥ä½œç›®å½•
          if [ "$(basename $(pwd))" == "melt" ]; then
            cd ..
          fi

      - name: åº”ç”¨éšè—ç‰¹å¾çš„è¡¥ä¸
        run: |
          # æ£€æŸ¥æ˜¯å¦åœ¨meltç›®å½•
          if [ ! -d "melt" ]; then
            echo "é”™è¯¯ï¼šmeltç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          # å¦‚æœä¸åœ¨meltç›®å½•ï¼Œåˆ™è¿›å…¥
          if [ "$(basename $(pwd))" != "melt" ]; then
            cd melt
          fi
          
          if [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            # æ³¨æ„ï¼šè·¯å¾„å·²ä¿®æ­£ä¸ºä»æ ¹ç›®å½•å¼€å§‹
            cp ../SukiSU_patch/69_hide_stuff.patch ./
          else
            # æ³¨æ„ï¼šè·¯å¾„å·²ä¿®æ­£ä¸ºä»æ ¹ç›®å½•å¼€å§‹
            cp ../susfs4ksu/kernel_patches/69_hide_stuff.patch ./
          fi
          patch -p1 -F 3 < 69_hide_stuff.patch
          
          # è¿”å›å·¥ä½œç›®å½•
          if [ "$(basename $(pwd))" == "melt" ]; then
            cd ..
          fi

      - name: Build kernel (without LTO)    
        run: |    
          # æ£€æŸ¥æ˜¯å¦åœ¨meltç›®å½•
          if [ ! -d "melt" ]; then
            echo "é”™è¯¯ï¼šmeltç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          # å¦‚æœä¸åœ¨meltç›®å½•ï¼Œåˆ™è¿›å…¥
          if [ "$(basename $(pwd))" != "melt" ]; then
            cd melt
          fi
          
          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ    
          export PATH="${{ env.CLANG_PATH }}:/usr/lib/ccache:${{ env.SYS_PATH }}:$PATH"    
          export CC="ccache clang"    
          export CXX="ccache clang++"    
              
          # æ¸…ç†å¹¶é…ç½®    
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 O=out mrproper    
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 O=out marble_defconfig    
          
          # é‡æ–°ç”Ÿæˆé…ç½®ï¼ˆç¡®ä¿æ‰€æœ‰è¡¥ä¸çš„é…ç½®ç”Ÿæ•ˆï¼‰
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 O=out olddefconfig
              
          # æ„å»ºå†…æ ¸    
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 O=out -j$(nproc --all)    
              
          # æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡    
          ccache -s
          
          # è¿”å›å·¥ä½œç›®å½•
          if [ "$(basename $(pwd))" == "melt" ]; then
            cd ..
          fi

      - name: ä¿®è¡¥ Image æ–‡ä»¶ (ä»…é™SukiSU)
        if: ${{ inputs.kernelsu_variant == 'SukiSU' && inputs.use_kpm }}
        run: |
          # æ£€æŸ¥æ˜¯å¦åœ¨meltç›®å½•
          if [ ! -d "melt" ]; then
            echo "é”™è¯¯ï¼šmeltç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          # è¿›å…¥meltç›®å½•
          cd melt
          
          # ç¡®å®šImageæ–‡ä»¶çš„ä½ç½®
          IMAGE_PATH="out/arch/arm64/boot/Image"
          
          # æ£€æŸ¥Imageæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$IMAGE_PATH" ]; then
            echo "é”™è¯¯ï¼šImageæ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          # ä¸‹è½½patchå·¥å…·
          echo "ä¸‹è½½KPMä¿®è¡¥å·¥å…·..."
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/main/kpm/patch_linux" -o patch_kpm
          chmod +x patch_kpm
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•å¹¶å¤åˆ¶Imageæ–‡ä»¶
          mkdir -p kpm_temp
          cp $IMAGE_PATH kpm_temp/Image
          
          # è¿›å…¥ä¸´æ—¶ç›®å½•æ‰§è¡Œä¿®è¡¥
          cd kpm_temp
          ../patch_kpm
          
          # æ£€æŸ¥æ˜¯å¦ä¿®è¡¥æˆåŠŸ
          if [ -f "oImage" ]; then
            # æ›¿æ¢åŸImageæ–‡ä»¶
            mv oImage ../$IMAGE_PATH
            echo "Imageæ–‡ä»¶ä¿®è¡¥æˆåŠŸï¼"
          else
            echo "è­¦å‘Šï¼šä¿®è¡¥å¯èƒ½å¤±è´¥ï¼Œæœªç”ŸæˆoImageæ–‡ä»¶"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          cd ..
          rm -rf kpm_temp
          rm patch_kpm
          
          # è¿”å›å·¥ä½œç›®å½•
          cd ..

      - name: Prepare artifacts    
        run: |    
          mkdir -p artifacts    
          cp melt/out/arch/arm64/boot/Image artifacts/kernel.img    
              
          # è·å–å†…æ ¸ç‰ˆæœ¬    
          grep -a "Linux version" melt/out/vmlinux | awk '{print $3}' | head -1 > artifacts/kernel_version.txt    
              
          echo "BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M')" >> $GITHUB_ENV    
          echo "KERNEL_VERSION=$(cat artifacts/kernel_version.txt)" >> $GITHUB_ENV    
              
          echo "=== æ„å»ºä¿¡æ¯ ==="    
          echo "ç‰ˆæœ¬: $(cat artifacts/kernel_version.txt)"    
          echo "æ—¥æœŸ: ${{ env.BUILD_DATE }}"    
          echo "================"    

      - name: Upload kernel image    
        if: ${{ inputs.build_type == 'image' }}    
        uses: actions/upload-artifact@v4    
        with:    
          name: kernel-image    
          path: artifacts/kernel.img    

      - name: Package AK3    
        if: ${{ inputs.build_type == 'ak3' }}    
        run: |    
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3    
          cp artifacts/kernel.img ak3/Image    
              
          # æ›´æ–°anykernel.shé…ç½®    
          sed -i \    
            -e "s|kernel\.string=.*|kernel.string=Marble-Kernel-${{ env.KERNEL_VERSION }}|" \    
            -e "s|device\.name1=.*|device.name1=marble|" \    
            -e "s|device\.name2=.*|device.name2=marblein|" \    
            ak3/anykernel.sh    
              
          # æ‰“åŒ…ZIP    
          cd ak3    
          zip -r9 "../artifacts/marble_melt_${{ env.KERNEL_VERSION }}.zip" *    
              
          echo "AK3_PATH=artifacts/marble_melt_${{ env.KERNEL_VERSION }}.zip" >> $GITHUB_ENV    

      - name: Upload AK3 package    
        if: ${{ inputs.build_type == 'ak3' }}    
        uses: actions/upload-artifact@v4    
        with:    
          name: kernel-ak3    
          path: ${{ env.AK3_PATH }}    

      - name: Create build summary    
        run: |    
          echo "### ğŸš€ å†…æ ¸æ„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY    
          echo "#### æºç ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY    
          echo "- ä»“åº“: [Guxin12/android_kernel_xiaomi_marble](https://github.com/Guxin12/android_kernel_xiaomi_marble)" >> $GITHUB_STEP_SUMMARY    
          echo "- åˆ†æ”¯: \`melt-rebase\`" >> $GITHUB_STEP_SUMMARY    
          echo "#### æ„å»ºå‚æ•°" >> $GITHUB_STEP_SUMMARY    
          echo "- ç±»å‹: \`${{ inputs.build_type }}\`" >> $GITHUB_STEP_SUMMARY    
          echo "- é…ç½®: \`marble_defconfig\`" >> $GITHUB_STEP_SUMMARY    
          echo "- KernelSUå˜ä½“: \`${{ inputs.kernelsu_variant }}\`" >> $GITHUB_STEP_SUMMARY    
          echo "- KernelSUåˆ†æ”¯: \`${{ inputs.kernelsu_branch }}\`" >> $GITHUB_STEP_SUMMARY    
          echo "- KPMæ”¯æŒ: \`${{ inputs.use_kpm }}\`" >> $GITHUB_STEP_SUMMARY    
          echo "#### ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY    
          echo "- å†…æ ¸ç‰ˆæœ¬: \`${{ env.KERNEL_VERSION }}\`" >> $GITHUB_STEP_SUMMARY    
          echo "- æ„å»ºæ—¶é—´: \`${{ env.BUILD_DATE }} UTC\`" >> $GITHUB_STEP_SUMMARY    
          echo "#### è¾“å‡ºæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY    
              
          if [ "${{ inputs.build_type }}" = "image" ]; then    
            echo "- Kernel Image: \`kernel.img\`" >> $GITHUB_STEP_SUMMARY    
          else    
            echo "- AK3 Package: \`$(basename ${{ env.AK3_PATH }})\`" >> $GITHUB_STEP_SUMMARY    
          fi    
              
          echo "> æ„å»ºID: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
